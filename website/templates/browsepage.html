{% extends "base.html" %}
{% block title %}Browse Files{% endblock %}
{% block content %}

<div class="container mt-5">
    <h2 class="text-center mb-4">Browse Files</h2>

    <!-- Filter Form -->
    <form class="row mb-4" id="searchForm">
        <div class="col-md-4 mb-2">
            <input type="text" class="form-control" id="searchText" name="searchText" placeholder="Search...">
        </div>
        <div class="col-md-3 mb-2">
            <select class="form-select" id="selectType" name="selectType">
                <option value="all">All</option>
                <option value="files">Files</option>
                <option value="users">Users</option>
            </select>
        </div>
        <div class="col-md-3 mb-2">
            <select class="form-select" id="selectFile" name="selectFile">
                <option value="all">All</option>
                <option value="documents">Documents</option>
                <option value="images">Images</option>
                <option value="videos">Videos</option>
                <option value="audios">Audios</option>
                <option value="others">Others</option>
            </select>
        </div>
        <div class="col-md-2 mb-2">
            <button type="submit" class="btn btn-primary w-100">Search</button>
        </div>
    </form>

    <!-- Dynamic Results Section -->
    <div id="results" class="row">
        <!-- Placeholder for file and user cards -->
    </div>
</div>

<!-- Password Modal -->
<div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="passwordForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Enter Password to Download</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="password" id="downloadPassword" class="form-control" placeholder="Enter password" required>
          <input type="hidden" id="fileIdToDownload">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Download</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
    // Example: dynamically render cards (replace with Flask loop later)
    const resultsContainer = document.getElementById("results");

    const exampleFiles = [
        { filename: "report.pdf", type: "Document", size: "1.2", owner: "john", password: true, isOwner: false },
        { filename: "photo.jpg", type: "Image", size: "0.5", owner: "you.jpg", password: false, isOwner: true },
    ];

    const exampleUsers = [
        { username: "you.jpg", uploads: 3, created: "2024-11-12" },
    ];

    function loadResults() {
        resultsContainer.innerHTML = "";

        exampleUsers.forEach(user => {
            resultsContainer.innerHTML += `
                <div class="col-md-4 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">ðŸ‘¤ ${user.username}</h5>
                            <p>Uploads: ${user.uploads}</p>
                            <p>Joined: ${user.created}</p>
                        </div>
                    </div>
                </div>
            `;
        });

        exampleFiles.forEach(file => {
            const lock = file.password ? '<span class="badge bg-warning">With Pass</span>' : '<span class="badge bg-success">No Pass</span>';
            const deleteBtn = file.isOwner ? `<button class="btn btn-danger btn-sm">Delete</button>` : '';
            const downloadBtn = file.password && !file.isOwner
                ? `<button class="btn btn-primary btn-sm" onclick="askPassword('${file.filename}')">Download</button>`
                : `<a href="/download/${file.filename}" class="btn btn-primary btn-sm">Download</a>`;

            resultsContainer.innerHTML += `
                <div class="col-md-4 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">${file.filename}</h5>
                            <p>Type: ${file.type}</p>
                            <p>Size: ${file.size} MB</p>
                            <p>Owner: ${file.owner}</p>
                            <p>${lock}</p>
                            ${downloadBtn} ${deleteBtn}
                        </div>
                    </div>
                </div>
            `;
        });
    }

    function askPassword(filename) {
        document.getElementById("fileIdToDownload").value = filename;
        new bootstrap.Modal(document.getElementById('passwordModal')).show();
    }

    
    // Close the password modal after successful verification
    document.getElementById("passwordForm").addEventListener("submit", function(event) {
        event.preventDefault();  // Prevent the form from submitting

        var password = document.getElementById("downloadPassword").value;
        var fileId = document.getElementById("fileIdToDownload").value;

        // Make the POST request to verify the password
        fetch("/verify-password", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
            },
            body: new URLSearchParams({
                file_id: fileId,
                password: password
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Hide the modal if the password is correct
                var modal = new bootstrap.Modal(document.getElementById('passwordModal'));
                modal.hide();

                // Trigger the file download after closing the modal
                window.location.href = data.download_url;
            } else {
                // Show an error message if the password is wrong
                alert("Incorrect password");
            }
        })
        .catch(error => {
            console.error("Error:", error);
        });
    });


</script>

{% endblock %}
