{% extends "base.html" %}
{% block title %}Browse Files{% endblock %}
{% block content %}

<style>
    .card {
    display: flex;
    flex-direction: column;
    height: 100%;
    }

    .card-body {
        flex-grow: 1;
    }

</style>


<div class="container mt-5">
    <h2 class="text-center mb-4">Browse Files</h2>

    <!-- Filter Form -->
    <form class="row mb-4" id="searchForm" method="get" action="{{ url_for('account_routes.browse') }}">
        <div class="col-md-4 mb-2">
            <input type="text" class="form-control" name="search" placeholder="Search..." value="{{ request.args.get('search', '') }}">
        </div>
        <div class="col-md-3 mb-2">
            <select class="form-select" name="type">
                <option value="all" {% if request.args.get('type') == 'all' %}selected{% endif %}>All</option>
                <option value="files" {% if request.args.get('type') == 'files' %}selected{% endif %}>Files</option>
                <option value="users" {% if request.args.get('type') == 'users' %}selected{% endif %}>Users</option>
            </select>
        </div>
        <div class="col-md-3 mb-2">
            <select class="form-select" name="file_type">
                <option value="all" {% if request.args.get('file_type') == 'all' %}selected{% endif %}>All</option>
                <option value="docs" {% if request.args.get('file_type') == 'docs' %}selected{% endif %}>Documents</option>
                <option value="image" {% if request.args.get('file_type') == 'image' %}selected{% endif %}>Images</option>
                <option value="video" {% if request.args.get('file_type') == 'video' %}selected{% endif %}>Videos</option>
                <option value="audio" {% if request.args.get('file_type') == 'audio' %}selected{% endif %}>Audios</option>
                <option value="others" {% if request.args.get('file_type') == 'others' %}selected{% endif %}>Others</option>
            </select>
        </div>
        <div class="col-md-2 mb-2">
            <button type="submit" class="btn btn-primary w-100">Search</button>
        </div>
    </form>

    <!-- Dynamic Results -->
    <div class="row" id="results">
        <!-- ðŸ”¹ User Cards -->
        {% for user in users %}
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">ðŸ‘¤ {{ user.username }}</h5>
                    <p>Uploads: {{ user.uploads_count }}</p>
                    <p>Joined: {{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'N/A' }}</p>
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- ðŸ”¹ File Cards -->
        {% for file in files %}
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">{{ file.filename }}</h5>
                    <p>Type: {{ file.file_type|capitalize }}</p>
                    <p>Size: {{ file.file_size_mb }} MB</p>
                    <p>Owner: {{ file.owner_username }}</p>
                    <p>
                        {% if file.is_protected %}
                            <span class="badge bg-warning">With Password</span>
                        {% else %}
                            <span class="badge bg-success">No Password</span>
                        {% endif %}
                    </p>
                    {% if file.is_owner %}
                        <a href="{{ url_for('file_routes.download_file', file_id=file.file_id) }}" class="btn btn-primary btn-sm">Download</a>
                        <form method="POST" action="{{ url_for('file_routes.delete_file', file_id=file.file_id) }}" style="display:inline;">
                            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                        </form>                        
                    {% else %}
                        {% if file.is_protected %}
                            <button class="btn btn-primary btn-sm" onclick="askPassword('{{ file.file_id }}')">Download</button>
                        {% else %}
                            <a href="{{ url_for('file_routes.download_file', file_id=file.file_id) }}" class="btn btn-primary btn-sm">Download</a>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Password Modal -->
<div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="passwordForm" method="POST" action="/verify-password">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Enter Password to Download</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="password" id="downloadPassword" name="password" class="form-control" placeholder="Enter password" required>
          <input type="hidden" id="fileIdToDownload" name="file_id">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Download</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
    function askPassword(fileId) {
        document.getElementById("fileIdToDownload").value = fileId;
        new bootstrap.Modal(document.getElementById('passwordModal')).show();
    }


     // Close the password modal after successful verification
     document.getElementById("passwordForm").addEventListener("submit", function(event) {
        event.preventDefault();  // Prevent the form from submitting

        var password = document.getElementById("downloadPassword").value;
        var fileId = document.getElementById("fileIdToDownload").value;

        // Make the POST request to verify the password
        fetch("/verify-password", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
            },
            body: new URLSearchParams({
                file_id: fileId,
                password: password
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Hide the modal if the password is correct
                var modal = new bootstrap.Modal(document.getElementById('passwordModal'));
                modal.hide();

                // Trigger the file download after closing the modal
                window.location.href = data.download_url;
            } else {
                // Show an error message if the password is wrong
                alert("Incorrect password");
            }
        })
        .catch(error => {
            console.error("Error:", error);
        });
    });

</script>

{% endblock %}
